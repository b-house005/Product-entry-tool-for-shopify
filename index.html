<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BrandHackers Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --blue: #1d72e8; --bg: #f8fafc; --white: #ffffff; --border: #e2e8f0; --text: #334155; --dark: #0f172a; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* TOAST NOTIFICATION */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: var(--dark); color: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); font-weight: 600; font-size: 0.9rem; opacity: 0; transform: translateY(-20px); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; gap: 10px; pointer-events: auto; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background: #ef4444; }
        .toast.success { background: #10b981; }

        /* LAYOUT BASE */
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100dvh; overflow: hidden; color: var(--text); }

        /* UTILS */
        .hidden { display: none !important; }
        .btn { cursor: pointer; padding: 10px 20px; border-radius: 8px; font-weight: 700; border: none; font-size: 0.9rem; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
        .btn-primary { background: var(--blue); color: white; box-shadow: 0 4px 10px rgba(29, 114, 232, 0.2); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-sec { background: white; border: 1px solid var(--border); color: #475569; }
        .btn-sec:active { background: #f1f5f9; }
        .btn-icon { padding: 8px; background: transparent; border: none; cursor: pointer; color: #94a3b8; font-size: 1.1rem; }
        .btn-icon:hover { color: var(--blue); }

        /* MOBILE ONLY CLASS */
        .mobile-only { display: none !important; }

        /* SETUP MODAL */
        #setupLayer { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .setup-card { background: white; width: 100%; max-width: 450px; padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .mode-opt { border: 2px solid var(--border); padding: 15px; border-radius: 10px; cursor: pointer; text-align: left; margin-bottom: 10px; transition:0.2s; }
        .mode-opt:hover { border-color: var(--blue); background: #f0f9ff; }
        .mode-opt.active { border-color: var(--blue); background: #eff6ff; }

        /* TOOLTIP LOGIC */
        .info-tip { color: #94a3b8; margin-left: 6px; cursor: help; position: relative; display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; border: 1px solid #cbd5e1; border-radius: 50%; font-size: 0.7rem; font-weight: bold; }
        .info-tip:hover { border-color: var(--blue); color: var(--blue); }
        .info-tip:hover::after { 
            content: attr(data-text); 
            position: absolute; top: 140%; left: 50%; transform: translateX(-50%); 
            background: var(--dark); color: white; padding: 12px; border-radius: 8px; 
            font-size: 0.75rem; width: 220px; text-align: center; z-index: 1000; pointer-events: none; line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .info-tip.right-side:hover::after { left: auto; right: 0; transform: none; text-align: left; }

        /* APP CONTAINER */
        .app-container { display: flex; width: 100%; height: 100%; position: relative; }
        
        /* MOBILE HEADER (Hidden on Desktop) */
        .mobile-header { display: none; height: 60px; background: white; border-bottom: 1px solid var(--border); align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; position: fixed; top: 0; left: 0; right: 0; z-index: 50; }
        
        /* SIDEBAR */
        .sidebar { width: 300px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 60; height: 100%; flex-shrink: 0; }
        .logo-area { height: 70px; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; gap: 10px; flex-shrink: 0; }
        .logo-img { height: 40px; width: auto; object-fit: contain; }
        .brand-name { font-weight: 800; font-size: 1.1rem; color: var(--dark); text-transform: uppercase; line-height: 1.1; }
        
        /* Close Button Hidden on Desktop */
        .mobile-close-btn { display: none; }

        .p-list { flex: 1; overflow-y: auto; padding: 15px; background: #fafafa; }
        .p-card { background: white; border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin-bottom: 8px; position: relative; transition:0.2s; }
        .p-card:hover { border-color: var(--blue); }
        .card-actions { position: absolute; top: 8px; right: 8px; display: flex; }
        .sidebar-footer { padding: 20px; border-top: 1px solid var(--border); background: white; flex-shrink: 0; }

        /* MAIN AREA */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .top-bar { height: 60px; background: white; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 30px; justify-content: space-between; flex-shrink: 0; }
        .steps { display: flex; gap: 20px; overflow-x: auto; height: 100%; align-items: center; }
        .step { font-weight: 600; color: #94a3b8; cursor: pointer; padding: 0 5px; height: 100%; display: flex; align-items: center; border-bottom: 3px solid transparent; font-size: 0.9rem; white-space: nowrap; }
        .step.active { color: var(--blue); border-bottom-color: var(--blue); }

        /* WORKSPACE & FORM SCROLLING FIX */
        .workspace { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            justify-content: center; 
            background: var(--bg); 
            -webkit-overflow-scrolling: touch; 
        }
        
        /* FORM WRAP */
        .form-wrap { width: 100%; max-width: 800px; padding-bottom: 50px; }

        /* EDITOR */
        .rte-container { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: white; margin-top: 8px; }
        .rte-container:focus-within { border-color: var(--blue); ring: 2px solid #eff6ff; }
        .rte-toolbar { background: #f8fafc; border-bottom: 1px solid var(--border); padding: 8px; display: flex; gap: 5px; flex-wrap: wrap; align-items: center; }
        .rte-btn { padding: 6px 10px; border: 1px solid transparent; background: transparent; border-radius: 4px; cursor: pointer; color: #64748b; font-size: 0.9rem; font-weight: 600; min-width: 32px; }
        .rte-btn:hover { background: #e2e8f0; }
        .rte-btn.active { background: #eff6ff; color: var(--blue); border-color: #bfdbfe; }
        .editor-content { min-height: 150px; padding: 15px; outline: none; font-size: 16px; line-height: 1.6; color: #334155; }
        .editor-content:empty:before { content: 'Type product description here...'; color: #94a3b8; }
        .editor-content h2 { margin-top: 0; font-size: 1.4rem; }
        .editor-content h3 { margin-top: 0; font-size: 1.2rem; }
        .editor-content ul, .editor-content ol { padding-left: 20px; }

        /* INPUTS */
        label { display: flex; align-items: center; font-weight: 700; font-size: 0.85rem; color: var(--dark); margin-bottom: 8px; margin-top: 20px; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; background: white; -webkit-appearance: none; }
        input:focus { border-color: var(--blue); outline: 2px solid #eff6ff; }

        /* COLLECTIONS */
        .chip-box { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .chip { background: #f1f5f9; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid transparent; transition:0.2s; }
        .chip.selected { background: var(--blue); color: white; border-color: var(--blue); }

        /* FOOTER */
        .action-bar { position: fixed; bottom: 0; right: 0; left: 300px; background: white; border-top: 1px solid var(--border); padding: 15px 30px; display: flex; justify-content: space-between; z-index: 50; }

        /* MOBILE OVERLAY */
        .mobile-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 55; }

        /* --- MOBILE SPECIFIC CSS --- */
        @media (max-width: 768px) {
            .mobile-only { display: block !important; }
            .app-container { flex-direction: column; margin-top: 60px; height: calc(100dvh - 60px); }
            
            .mobile-header { display: flex; }
            .sidebar .logo-group { display: none; }
            
            .sidebar { 
                position: fixed; top: 0; left: 0; bottom: 0; width: 85%; max-width: 300px; 
                transform: translateX(-100%); transition: transform 0.3s ease; 
                z-index: 100; box-shadow: 2px 0 10px rgba(0,0,0,0.1); height: 100dvh;
            }
            .sidebar.open { transform: translateX(0); }
            
            /* Sidebar Context inside Drawer */
            .sidebar .logo-area { display: flex; justify-content: flex-end; } 
            .sidebar .logo-area .logo-group { display: none; }
            
            .mobile-close-btn { display: block; font-size: 1.5rem; cursor: pointer; color: #94a3b8; }

            .mobile-overlay.open { display: block; }
            
            .main { width: 100%; height: 100%; }
            .top-bar { padding: 0 15px; }
            .action-bar { left: 0; padding: 15px; }
            
            /* Scroll fix: Ensure padding is massive on mobile so nothing is hidden */
            .workspace { padding-bottom: 0; }
            .form-wrap { padding-bottom: 50px; }
        }
    </style>
</head>
<body>

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>

<!-- CONFIRM MODAL -->
<div id="confirmLayer" class="hidden" style="position:fixed; inset:0; background:rgba(15,23,42,0.6); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px;">
    <div style="background:white; padding:30px; border-radius:16px; width:100%; max-width:400px; text-align:center; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);">
        <div style="width:60px; height:60px; background:#fee2e2; color:#ef4444; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.8rem; margin:0 auto 20px auto;">
            <i class="fa-solid fa-triangle-exclamation"></i>
        </div>
        <h3 id="confTitle" style="margin:0 0 10px 0; color:#1e293b;">Reset Everything?</h3>
        <p id="confDesc" style="color:#64748b; margin:0 0 25px 0; line-height:1.5;">This will delete all products and reset the app. This action cannot be undone.</p>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-sec" style="flex:1;" onclick="closeConfirm()">Cancel</button>
            <button id="confBtn" class="btn btn-primary" style="flex:1; background:#ef4444; border-color:#ef4444;" onclick="onConfirmClick()">Yes, Reset</button>
        </div>
    </div>
</div>

<!-- SETUP -->
<div id="setupLayer">
    <div class="setup-card">
        <div style="display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:25px;">
            <img src="logo.png" onerror="this.style.display='none'" style="height:45px;">
            <div style="font-weight:800; font-size:1.4rem; color:#0f172a;">BRANDHACKERS</div>
        </div>
        
        <div style="text-align:left; margin-bottom:20px;">
            <label style="margin-top:0">Your Store Name</label>
            <input type="text" id="setupBrand" placeholder="e.g. My Fashion Store">
        </div>
        <div class="mode-opt active" onclick="setMode('single', this)"><strong>Single Brand</strong> (I sell my own products)</div>
        <div class="mode-opt" onclick="setMode('multi', this)"><strong>Multi-Brand</strong> (I resell other brands)</div>
        <button class="btn btn-primary" style="margin-top:20px; width:100%;" onclick="finishSetup()">Start</button>
    </div>
</div>

<!-- MOBILE HEADER (Sticky) -->
<div class="mobile-header">
    <div style="display:flex; align-items:center; gap:10px;">
        <img src="logo.png" onerror="this.style.display='none'" style="height:35px;">
        <div class="brand-name" style="font-size:1rem;">BRAND<br>HACKERS</div>
    </div>
    <div onclick="toggleSidebar()" style="font-size:1.5rem; color:#334155; cursor:pointer; padding:5px;">
        <i class="fa-solid fa-bars"></i>
    </div>
</div>

<div class="mobile-overlay" onclick="toggleSidebar()"></div>

<div class="app-container">
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="logo-area">
            <div class="logo-group">
                <img src="logo.png" onerror="this.style.display='none'" class="logo-img">
                <span class="brand-name">BRANDHACKERS</span>
            </div>
            <!-- X Button: Hidden by default, shown via 'mobile-only' class on small screens -->
            <i class="fa-solid fa-xmark mobile-only" style="font-size:1.5rem; cursor:pointer; color:#94a3b8;" onclick="toggleSidebar()"></i>
        </div>
        
        <div class="p-list" id="productList">
            <div style="text-align:center; padding-top:50px; color:#94a3b8; font-size:0.9rem;">Queue is empty.</div>
        </div>
        
        <div class="sidebar-footer">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-sec" style="flex:1; border-color:#fee2e2; color:#ef4444;" onclick="triggerReset()">Reset</button>
                <button class="btn btn-primary" style="flex:2;" onclick="exportData()">Submit</button>
            </div>
        </div>
    </div>

    <!-- MAIN -->
    <div class="main">
        <div class="top-bar">
            <div class="steps">
                <div class="step active" id="t1" onclick="navTo(1)">1. Details</div>
                <div class="step" id="t2" onclick="navTo(2)">2. Options & Price</div>
                <div class="step" id="t3" onclick="navTo(3)">3. Images</div>
            </div>
        </div>

        <div class="workspace">
            <div class="form-wrap">
                
                <!-- STEP 1 -->
                <div id="step1" class="step-content active">
                    <label style="margin-top:0">Product Name</label>
                    <input type="text" id="pTitle" placeholder="e.g. Classic White Tee">

                    <div id="vendorBox" class="hidden">
                        <label>Brand Manufacturer <span class="info-tip" data-text="The 'Vendor' in Shopify.">!</span></label>
                        <input type="text" id="pVendor">
                    </div>

                    <label>Description</label>
                    
                    <!-- EDITOR -->
                    <div class="rte-container">
                        <div class="rte-toolbar" id="rteToolbar">
                            <button class="rte-btn" id="btnB" onmousedown="event.preventDefault(); exec('bold')" title="Bold">B</button>
                            <button class="rte-btn" id="btnI" onmousedown="event.preventDefault(); exec('italic')" title="Italic">I</button>
                            <button class="rte-btn" id="btnU" onmousedown="event.preventDefault(); exec('underline')" title="Underline">U</button>
                            <div style="width:1px; height:20px; background:#cbd5e1; margin:0 5px;"></div>
                            <button class="rte-btn" id="btnH2" onmousedown="event.preventDefault(); exec('formatBlock', 'H2')">Heading 1</button>
                            <button class="rte-btn" id="btnH3" onmousedown="event.preventDefault(); exec('formatBlock', 'H3')">Heading 2</button>
                            <button class="rte-btn" id="btnP" onmousedown="event.preventDefault(); exec('formatBlock', 'P')" title="Normal Paragraph">Normal</button>
                            <div style="width:1px; height:20px; background:#cbd5e1; margin:0 5px;"></div>
                            <button class="rte-btn" id="btnUL" onmousedown="event.preventDefault(); exec('insertUnorderedList')"><i class="fa-solid fa-list-ul"></i></button>
                            <button class="rte-btn" id="btnOL" onmousedown="event.preventDefault(); exec('insertOrderedList')"><i class="fa-solid fa-list-ol"></i></button>
                        </div>
                        <div id="pDesc" class="editor-content" contenteditable="true" onkeyup="updateToolbar()" onmouseup="updateToolbar()" onclick="updateToolbar()"></div>
                    </div>

                    <label>Categories <span class="info-tip" data-text="Tags or Collections (e.g. 'Summer', 'Men').">!</span></label>
                    <div class="collection-area" style="background:white; border:1px solid var(--border); padding:15px; border-radius:8px;">
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="newCat" placeholder="e.g. Summer" style="flex:1">
                            <button class="btn btn-sec" onclick="addCollection()">Add</button>
                        </div>
                        <div id="savedCollections" class="chip-box"></div>
                    </div>
                    
                    <!-- SPACER DIV TO FORCE SCROLL -->
                    <div style="height: 150px; width: 100%; clear: both;"></div>
                </div>

                <!-- STEP 2 -->
                <div id="step2" class="step-content hidden">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div>
                            <label style="margin-top:0">Selling Price (₹)</label>
                            <input type="number" id="pPrice" placeholder="999">
                        </div>
                        <div>
                            <label style="margin-top:0">Original Price <span class="info-tip right-side" data-text="The higher price before discount. Shows as crossed-out.">!</span></label>
                            <input type="number" id="pCompare" placeholder="1999">
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div><label>Stock Code (SKU) <span class="info-tip" data-text="Unique code to track inventory.">!</span></label><input type="text" id="pSku" placeholder="ABC-001"></div>
                        <div><label>Total Quantity</label><input type="number" id="pQty" value="100"></div>
                    </div>
                    <hr style="margin:30px 0; border:0; border-top:1px solid #e2e8f0;">
                    
                    <div style="background:white; border:1px solid #cbd5e1; border-radius:8px; padding:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <h4 style="margin:0; font-size:1rem; color:#334155;">Options (Size, Color)</h4>
                            <button class="btn btn-sec" style="padding:6px 12px; font-size:0.8rem;" onclick="addOptionRow()">+ Add Option</button>
                        </div>
                        <div id="variantList"></div>
                    </div>
                    
                    <!-- SPACER DIV -->
                    <div style="height: 150px; width: 100%;"></div>
                </div>

                <!-- STEP 3 -->
                <div id="step3" class="step-content hidden">
                    <div style="border: 2px dashed #cbd5e1; border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; background: #f8fafc;" onclick="document.getElementById('fileIn').click()">
                        <i class="fa-solid fa-cloud-arrow-up" style="font-size:2.5rem; color:#cbd5e1;"></i>
                        <h3 style="margin:10px 0 5px 0;">Click to Upload Photos</h3>
                        <p style="color:#64748b; font-size:0.9rem; margin:0;">Select Multiple Images (JPG/PNG)</p>
                        <input type="file" id="fileIn" multiple style="display:none" onchange="uploadFiles()">
                    </div>
                    <div id="upStatus" style="text-align:center; margin-top:15px; font-weight:bold; color:var(--blue);"></div>
                    <div id="imgPreview" style="display:flex; gap:10px; margin-top:20px; flex-wrap:wrap; overflow-x:auto;"></div>
                    
                    <!-- SPACER DIV -->
                    <div style="height: 150px; width: 100%;"></div>
                </div>

            </div>
        </div>

        <div class="action-bar">
            <button class="btn btn-sec" id="btnBack" onclick="changeStep(-1)" disabled>Back</button>
            <button class="btn btn-primary" id="btnNext" onclick="changeStep(1)" style="width:auto;">Next Step</button>
        </div>
    </div>
</div>

<script>
    const KEY = "a38ae5cb0e2fb3c9e6bbeb7276c5bd28";
    const MAIL = "hello.brandhackers@gmail.com";
    
    let state = { brand: '', type: 'single', products: [], savedCollections: ['New Arrival'] };
    let form = { imgs: [], opts: [], selectedCols: [] };
    let step = 1;

    // --- PERSISTENCE START ---
    
    // Toast System
    function showToast(msg, type='normal') {
        const c = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerHTML = type === 'error' ? `<i class="fa-solid fa-circle-exclamation"></i> ${msg}` : 
                      type === 'success' ? `<i class="fa-solid fa-circle-check"></i> ${msg}` : msg;
        c.appendChild(t);
        requestAnimationFrame(() => t.classList.add('show'));
        setTimeout(() => {
            t.classList.remove('show');
            setTimeout(() => t.remove(), 300);
        }, 3000);
    }

    // Confirm System
    let confirmCallback = null;
    function showConfirm(title, desc, actionText, cb) {
        document.getElementById('confTitle').innerText = title;
        document.getElementById('confDesc').innerText = desc;
        document.getElementById('confBtn').innerText = actionText;
        confirmCallback = cb;
        document.getElementById('confirmLayer').classList.remove('hidden');
    }
    function closeConfirm() { document.getElementById('confirmLayer').classList.add('hidden'); }
    function onConfirmClick() {
        if(confirmCallback) confirmCallback();
        closeConfirm();
    }
    
    function triggerReset() {
        showConfirm("Reset Everything?", "This will delete all products and reset the app. This action cannot be undone.", "Yes, Reset", () => {
            localStorage.removeItem('bh_workspace');
            location.reload();
        });
    }

    function saveProgress() {
        const draft = {
            title: document.getElementById('pTitle').value,
            vendor: document.getElementById('pVendor').value,
            desc: document.getElementById('pDesc').innerHTML,
            price: document.getElementById('pPrice').value,
            compare: document.getElementById('pCompare').value,
            sku: document.getElementById('pSku').value,
            qty: document.getElementById('pQty').value,
            newCat: document.getElementById('newCat').value
        };
        const data = { state, form, step, draft, timestamp: Date.now() };
        localStorage.setItem('bh_workspace', JSON.stringify(data));
    }

    function loadProgress() {
        const raw = localStorage.getItem('bh_workspace');
        if(!raw) return;
        try {
            const data = JSON.parse(raw);
            state = data.state || state;
            form = data.form || form;
            
            // Restore UI for State
            if(state.brand) {
                document.getElementById('setupLayer').style.display = 'none';
                document.getElementById('setupBrand').value = state.brand;
                if(state.type === 'multi') {
                    document.getElementById('vendorBox').classList.remove('hidden');
                    // Visually select Multi
                    document.querySelectorAll('.mode-opt').forEach(x => x.classList.remove('active'));
                    document.querySelectorAll('.mode-opt')[1].classList.add('active');
                }
            }

            // Restore Draft Inputs
            if(data.draft) {
                document.getElementById('pTitle').value = data.draft.title || '';
                document.getElementById('pVendor').value = data.draft.vendor || '';
                document.getElementById('pDesc').innerHTML = data.draft.desc || '';
                document.getElementById('pPrice').value = data.draft.price || '';
                document.getElementById('pCompare').value = data.draft.compare || '';
                document.getElementById('pSku').value = data.draft.sku || '';
                document.getElementById('pQty').value = data.draft.qty || '100';
                document.getElementById('newCat').value = data.draft.newCat || '';
            }

            // Render Everything
            renderList();
            renderCollections();
            renderOpts();
            renderImages();
            
            // Navigate to saved step
            updateStepUI(data.step || 1);

        } catch(e) {
            console.error("Load failed", e);
            localStorage.removeItem('bh_workspace'); // Clear corrupted data
        }
    }

    // Auto-save debouncer
    let saveTimer;
    function autoSave() {
        clearTimeout(saveTimer);
        saveTimer = setTimeout(saveProgress, 1000);
    }
    
    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
        loadProgress();
        // Attach listeners for auto-save
        document.querySelectorAll('input, select').forEach(el => el.addEventListener('input', autoSave));
        document.getElementById('pDesc').addEventListener('input', autoSave);
    });
    // --- PERSISTENCE END ---

    function setMode(t, e) {
        state.type = t;
        document.querySelectorAll('.mode-opt').forEach(x => x.classList.remove('active'));
        e.classList.add('active');
        saveProgress();
    }
    function finishSetup() {
        const b = document.getElementById('setupBrand').value;
        if(!b) return alert("Enter Store Name");
        state.brand = b;
        document.getElementById('setupLayer').style.display='none';
        if(state.type === 'multi') document.getElementById('vendorBox').classList.remove('hidden');
        renderCollections();
        addOptionRow();
        saveProgress();
    }
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.querySelector('.mobile-overlay').classList.toggle('open');
    }

    function navTo(target) {
        if(target > step && step === 1 && !document.getElementById('pTitle').value) return alert("Please enter Product Name");
        updateStepUI(target);
        saveProgress();
    }
    function changeStep(dir) {
        const next = step + dir;
        if(next > 3) { saveProduct(); return; }
        updateStepUI(next);
        saveProgress();
    }
    function updateStepUI(target) {
        document.querySelectorAll('.step-content').forEach(e => e.classList.add('hidden'));
        document.querySelectorAll('.step').forEach(e => e.classList.remove('active'));
        document.getElementById(`step${target}`).classList.remove('hidden');
        document.getElementById(`t${target}`).classList.add('active');
        step = target;
        document.getElementById('btnBack').disabled = (step===1);
        document.getElementById('btnNext').innerText = (step===3) ? "Finish & Add" : "Next Step";
        window.scrollTo(0,0);
    }

    /* EDITOR */
    function exec(cmd, val=null) { 
        document.execCommand(cmd, false, val); 
        updateToolbar();
    }
    function updateToolbar() {
        const map = {'bold':'btnB', 'italic':'btnI', 'underline':'btnU', 'insertUnorderedList':'btnUL', 'insertOrderedList':'btnOL', 'formatBlock':'btnP'};
        for (let cmd in map) {
            if (document.queryCommandState(cmd)) document.getElementById(map[cmd])?.classList.add('active');
            else document.getElementById(map[cmd])?.classList.remove('active');
        }
        const parent = window.getSelection().anchorNode?.parentElement;
        if(parent) {
            const tag = parent.tagName;
            document.getElementById('btnH2').classList.toggle('active', tag === 'H2');
            document.getElementById('btnH3').classList.toggle('active', tag === 'H3');
            document.getElementById('btnP').classList.toggle('active', tag === 'P');
        }
    }

    /* LOGIC */
    function addCollection() {
        const val = document.getElementById('newCat').value.trim();
        if(val) {
            if(!state.savedCollections.includes(val)) state.savedCollections.push(val);
            if(!form.selectedCols.includes(val)) form.selectedCols.push(val);
            document.getElementById('newCat').value = '';
            renderCollections();
            saveProgress();
        }
    }
    function renderCollections() {
        document.getElementById('savedCollections').innerHTML = state.savedCollections.map(col => {
            const sel = form.selectedCols.includes(col);
            return `<div class="chip ${sel ? 'selected' : ''}" onclick="toggleCol('${col}')">${col}</div>`;
        }).join('');
    }
    function toggleCol(col) {
        if(form.selectedCols.includes(col)) form.selectedCols = form.selectedCols.filter(c => c !== col);
        else form.selectedCols.push(col);
        renderCollections();
        saveProgress();
    }

    function addOptionRow() {
        if(form.opts.length >= 3) return;
        form.opts.push({n:'', v:''});
        renderOpts();
        saveProgress();
    }
    function renderOpts() {
        const d = document.getElementById('variantList');
        if(form.opts.length === 0) return d.innerHTML = '<div style="text-align:center; color:#94a3b8; font-size:0.9rem;">No options.</div>';
        d.innerHTML = form.opts.map((o,i) => `
            <div style="display:grid; grid-template-columns:1fr 2fr 30px; gap:10px; margin-bottom:10px;">
                <input type="text" placeholder="Name (Size)" value="${o.n}" onchange="form.opts[${i}].n=this.value; saveProgress()">
                <input type="text" placeholder="Values (S, M, L)" value="${o.v}" onchange="form.opts[${i}].v=this.value; saveProgress()">
                <i class="fa-solid fa-trash" onclick="form.opts.splice(${i},1);renderOpts(); saveProgress()" style="color:#ef4444; cursor:pointer; margin-top:12px;"></i>
            </div>
        `).join('');
    }

    function renderImages() {
        const d = document.getElementById('imgPreview');
        d.innerHTML = form.imgs.map((u,i) => `
            <div style="position:relative;">
                <img src="${u}" style="width:70px; height:70px; border-radius:6px; object-fit:cover; border:1px solid #e2e8f0;">
                <button onclick="removeImg(${i})" style="position:absolute; top:-8px; right:-8px; background:#ef4444; color:white; border:none; border-radius:50%; width:22px; height:22px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:12px; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        `).join('');
    }

    function removeImg(i) {
        form.imgs.splice(i, 1);
        renderImages();
        saveProgress();
    }

    async function uploadFiles() {
        const fs = document.getElementById('fileIn').files;
        if(fs.length === 0) return;
        const status = document.getElementById('upStatus');
        status.innerText = `Uploading ${fs.length} images...`;
        status.style.color = 'var(--blue)';
        
        let errors = 0;
        for(let f of fs) {
            let fd = new FormData(); fd.append('image', f);
            try {
                let r = await fetch(`https://api.imgbb.com/1/upload?key=${KEY}`, {method:'POST', body:fd});
                let d = await r.json();
                if(d.success) {
                    form.imgs.push(d.data.url);
                    renderImages();
                    saveProgress();
                } else {
                    errors++;
                }
            } catch(e){
                console.error(e);
                errors++;
            }
        }
        
        if(errors > 0) {
            status.innerText = `Done. ${errors} failed.`;
            status.style.color = '#ef4444';
        } else {
            status.innerText = "Upload Complete!";
            status.style.color = '#10b981';
            setTimeout(() => { status.innerText = ""; }, 3000);
        }
        document.getElementById('fileIn').value = ''; // Reset input
    }

    /* SAVE & DUPE */
    function saveProduct() {
        if(!document.getElementById('pTitle').value) return showToast("Product Name required", "error");
        state.products.push({
            title: document.getElementById('pTitle').value,
            vendor: state.type === 'single' ? state.brand : document.getElementById('pVendor').value,
            desc: document.getElementById('pDesc').innerHTML,
            cats: [...form.selectedCols],
            price: document.getElementById('pPrice').value,
            compare: document.getElementById('pCompare').value,
            sku: document.getElementById('pSku').value,
            qty: document.getElementById('pQty').value,
            opts: JSON.parse(JSON.stringify(form.opts)),
            imgs: [...form.imgs]
        });
        renderList();
        reset();
        showToast("Product Saved to Queue!", "success");
        saveProgress();
    }

    function dupe(i) {
        const p = state.products[i];
        document.getElementById('pTitle').value = p.title + " (Copy)";
        if(state.type === 'multi') document.getElementById('pVendor').value = p.vendor;
        document.getElementById('pDesc').innerHTML = p.desc;
        document.getElementById('pPrice').value = p.price;
        document.getElementById('pCompare').value = p.compare;
        document.getElementById('pSku').value = p.sku;
        document.getElementById('pQty').value = p.qty;
        form.opts = JSON.parse(JSON.stringify(p.opts));
        form.selectedCols = [...p.cats];
        form.imgs = [...p.imgs];
        renderCollections(); renderOpts(); renderImages();
        updateStepUI(1);
        if(window.innerWidth <= 768) toggleSidebar();
        saveProgress();
    }

    function reset() {
        document.getElementById('pTitle').value = '';
        if(state.type==='multi') document.getElementById('pVendor').value = '';
        document.getElementById('pDesc').innerHTML = '';
        document.getElementById('pPrice').value = '';
        document.getElementById('pCompare').value = '';
        document.getElementById('pSku').value = '';
        document.getElementById('pQty').value = '100';
        form.imgs = []; form.opts = []; form.selectedCols = [];
        renderCollections(); renderOpts(); renderImages();
        updateStepUI(1);
        saveProgress();
    }

    function deleteProduct(i) {
        if(confirm("Delete this product?")) {
            state.products.splice(i,1);
            renderList();
            saveProgress();
            showToast("Product deleted", "normal");
        }
    }

    function renderList() {
        const l = document.getElementById('productList');
        if(state.products.length === 0) return l.innerHTML=`<div style="text-align:center; padding-top:50px; color:#94a3b8; font-size:0.9rem;">Queue is empty.</div>`;
        l.innerHTML = state.products.map((p,i) => `
            <div class="p-card">
                <div class="card-actions">
                    <button class="btn-icon" onclick="dupe(${i})" title="Duplicate"><i class="fa-regular fa-copy"></i></button>
                    <button class="btn-icon" onclick="deleteProduct(${i})" style="color:#ef4444;" title="Delete"><i class="fa-solid fa-trash"></i></button>
                </div>
                <div style="font-weight:700; padding-right:60px;">${p.title}</div>
                <div style="font-size:0.85rem; color:#64748b; margin-top:4px;">₹${p.price}</div>
            </div>
        `).join('');
    }

    /* EXPORT */
    function cartesian(args) {
        var r = [], max = args.length-1;
        function helper(arr, i) {
            for (var j=0, l=args[i].length; j<l; j++) {
                var a = arr.slice(0); a.push(args[i][j]);
                if (i==max) r.push(a); else helper(a, i+1);
            }
        }
        helper([], 0);
        return r;
    }

    function exportData() {
        if(state.products.length === 0) return alert("Nothing to submit");
        const headerLine = "Title,URL handle,Description,Vendor,Product category,Type,Tags,Published on online store,Status,SKU,Barcode,Option1 name,Option1 value,Option2 name,Option2 value,Option3 name,Option3 value,Price,Price / International,Compare-at price,Compare-at price / International,Cost per item,Charge tax,Tax code,Unit price total measure,Unit price total measure unit,Unit price base measure,Unit price base measure unit,Inventory tracker,Inventory quantity,Continue selling when out of stock,Weight value (grams),Weight unit for display,Requires shipping,Fulfillment service,Product image URL,Image position,Image alt text,Variant image URL,Gift card,SEO title,SEO description,Google Shopping / Google product category,Google Shopping / Gender,Google Shopping / Age group,Google Shopping / MPN,Google Shopping / AdWords Grouping,Google Shopping / AdWords labels,Google Shopping / Condition,Google Shopping / Custom product,Google Shopping / Custom label 0,Google Shopping / Custom label 1,Google Shopping / Custom label 2,Google Shopping / Custom label 3,Google Shopping / Custom label 4";
        const columns = headerLine.split(',');
        let csv = headerLine + "\n";
        const esc = t => `"${(t||"").toString().replace(/"/g, '""')}"`;
        const slugify = (t) => {
            const s = (t || "").toString().toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            return s || "product";
        };
        const makeUniqueHandle = (base, used) => {
            let h = base;
            let n = 2;
            while(used.has(h)) { h = `${base}-${n}`; n++; }
            used.add(h);
            return h;
        };
        const numStr = (v) => {
            const s = (v ?? "").toString().trim();
            if(!s) return "";
            const n = Number(s);
            return Number.isFinite(n) ? s : "";
        };
        const skuPart = (t) => (t || "").toString().trim().toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
        const buildVariantSku = (baseSku, vals) => {
            const b = (baseSku || "").toString().trim();
            if(!b) return "";
            const parts = (vals || []).map(skuPart).filter(Boolean);
            if(parts.length === 0) return b;
            return `${b}-${parts.join('-')}`;
        };

        const errors = [];
        state.products.forEach((p, idx) => {
            const label = p && p.title ? p.title : `#${idx+1}`;
            if(!p || !p.title) errors.push(`${label}: Title missing`);
            const v = (p && p.vendor) ? p.vendor.toString().trim() : "";
            if(!v) errors.push(`${label}: Vendor missing`);
            if(!numStr(p && p.price)) errors.push(`${label}: Price missing/invalid`);
            if(!numStr(p && p.qty)) errors.push(`${label}: Inventory quantity missing/invalid`);
        });
        if(errors.length) return alert("Fix these before export:\n\n" + errors.slice(0, 20).join("\n") + (errors.length > 20 ? `\n...and ${errors.length-20} more` : ""));

        const usedHandles = new Set();
        state.products.forEach(p => {
            const h = makeUniqueHandle(slugify(p.title), usedHandles);
            let vars = [];
            let activeOpts = p.opts.filter(o => o.n && o.v);
            
            if(activeOpts.length > 0) {
                const arrs = activeOpts.map(o => o.v.split(',').map(s=>s.trim()).filter(Boolean));
                if(arrs.length > 0 && arrs[0].length > 0) {
                    const combos = (arrs.length===1) ? arrs[0].map(x=>[x]) : cartesian(arrs);
                    combos.forEach(c => {
                        vars.push({
                            o1n: activeOpts[0]?.n, o1v: c[0],
                            o2n: activeOpts[1]?.n, o2v: c[1],
                            o3n: activeOpts[2]?.n, o3v: c[2]
                        });
                    });
                }
            } else { vars.push({o1n:"Title", o1v:"Default Title"}); }

            const imgs = Array.isArray(p.imgs) ? p.imgs.filter(Boolean) : [];
            const firstImg = imgs[0] || "";

            for(let i=0; i<vars.length; i++) {
                let v = vars[i] || {};
                let f = (i===0);
                const rowObj = {};

                rowObj["Title"] = f ? p.title : "";
                rowObj["URL handle"] = h;
                rowObj["Description"] = f ? p.desc : "";
                rowObj["Vendor"] = f ? p.vendor : "";
                rowObj["Tags"] = f ? p.cats.join(',') : "";
                rowObj["Published on online store"] = f ? "TRUE" : "";
                rowObj["Status"] = f ? "active" : "";

                rowObj["Option1 name"] = v.o1n || "";
                rowObj["Option1 value"] = v.o1v || "";
                rowObj["Option2 name"] = v.o2n || "";
                rowObj["Option2 value"] = v.o2v || "";
                rowObj["Option3 name"] = v.o3n || "";
                rowObj["Option3 value"] = v.o3v || "";

                const optVals = [v.o1v, v.o2v, v.o3v].filter(Boolean);
                rowObj["SKU"] = v.o1v ? buildVariantSku(p.sku, optVals) : "";
                rowObj["Price"] = v.o1v ? numStr(p.price) : "";
                rowObj["Compare-at price"] = v.o1v ? numStr(p.compare) : "";
                rowObj["Inventory tracker"] = v.o1v ? "shopify" : "";
                rowObj["Inventory quantity"] = v.o1v ? numStr(p.qty) : "";
                rowObj["Continue selling when out of stock"] = v.o1v ? "FALSE" : "";
                rowObj["Charge tax"] = v.o1v ? "TRUE" : "";
                rowObj["Requires shipping"] = v.o1v ? "TRUE" : "";
                rowObj["Fulfillment service"] = v.o1v ? "manual" : "";

                rowObj["Product image URL"] = f ? firstImg : "";
                rowObj["Image position"] = f && firstImg ? "1" : "";
                rowObj["Variant image URL"] = v.o1v ? firstImg : "";

                const row = columns.map(c => esc(rowObj[c] || ""));
                csv += row.join(",") + "\n";
            }

            for(let j=1; j<imgs.length; j++) {
                const rowObj = {};
                rowObj["URL handle"] = h;
                rowObj["Product image URL"] = imgs[j];
                rowObj["Image position"] = String(j + 1);
                const row = columns.map(c => esc(rowObj[c] || ""));
                csv += row.join(",") + "\n";
            }
        });

        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const safeBrand = (state.brand || "BrandHackers").toString().trim().replace(/[\\\/:*?"<>|]+/g, '').replace(/\s+/g, '_').slice(0, 60) || "BrandHackers";
        const today = new Date();
        const y = today.getFullYear();
        const m = String(today.getMonth() + 1).padStart(2, '0');
        const d = String(today.getDate()).padStart(2, '0');
        a.download = `${safeBrand}_Products_${y}-${m}-${d}.csv`;
        a.click();
        
        if(window.innerWidth <= 768 && document.getElementById('sidebar').classList.contains('open')) {
            toggleSidebar();
        }

        setTimeout(() => { window.location.href = `mailto:${MAIL}?subject=Product Data&body=Attached CSV file.`; }, 1000);
    }
</script>
</body>
</html>


